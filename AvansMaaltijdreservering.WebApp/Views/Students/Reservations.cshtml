@model AvansMaaltijdreservering.WebApp.ViewModels.Students.StudentReservationsViewModel
@{
    ViewData["Title"] = "My reservations";
}

<div class="mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="labrada-font">My reservations</h1>
            <p class="text-muted mb-0">
                Hello @Model.Student.Name â€¢ 
                @Model.Reservations.Count reservation@(Model.Reservations.Count != 1 ? "s" : "")
            </p>
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }


    <hr class="my-5">

    <!-- Metrics -->
    @if (Model.Reservations.Any())
    {
        var totalPackages = Model.Reservations.Count();
        
        <div class="row mb-4">
            <div class="col-12">
                <h3 class="labrada-font">Metrics</h3>
                <p class="text-muted mb-4">Your impact and account status</p>
            </div>
        </div>
        
        <div class="row mb-5">
            <!-- Left Column - Package Rescued (50%) -->
            <div class="col-md-6 mb-3">
                <div class="dashboard-stats-card">
                    <div class="dashboard-stats-title">@totalPackages</div>
                    <div class="dashboard-stats-label">Packages Rescued</div>
                </div>
            </div>

            <!-- Right Column - No Shows (50%) -->
            <div class="col-md-6 mb-3">
                <div class="dashboard-stats-card">
                    <div class="dashboard-stats-title">@Model.Student.NoShowCount</div>
                    <div class="dashboard-stats-label">No Shows</div>
                    @if (Model.Student.NoShowCount >= 2)
                    {
                        <div class="mt-2">
                            <span class="warning-text">Account blocked</span>
                        </div>
                    }
                    else if (Model.Student.NoShowCount >= 1)
                    {
                        <div class="mt-2 text-muted">
                            <small>@(2 - Model.Student.NoShowCount) more until blocked</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Your Reservations Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="labrada-font">Your reservations (@Model.Reservations.Count())</h3>
            <p class="text-muted mb-4">Your personal meal package reservations</p>
        </div>
    </div>

    @if (!Model.Reservations.Any())
    {
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="display-1 text-muted mb-3">ðŸ“…</div>
                    <h4 class="text-muted">No reservations yet</h4>
                    <p class="text-muted">Start saving food by reserving your first package!</p>
                    <a asp-action="Dashboard" class="meal-filter-btn">
                        <i class="bi bi-search"></i> Browse Available Packages
                    </a>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var reservation in Model.Reservations)
            {
                var isUpcoming = reservation.PickupTime > DateTime.Now;
                var isPastDue = reservation.LatestPickupTime < DateTime.Now;
                var isToday = reservation.PickupTime.Date == DateTime.Today;
                
                <div class="col-md-6 mb-4">
                    <div class="package-details-card">
                        <div class="package-details-header">
                            <h1 class="package-details-title labrada-font">
                                @reservation.Name
                                @if (isToday)
                                {
                                    <span class="warning-text">Today!</span>
                                }
                            </h1>
                            <div class="package-details-price">â‚¬@reservation.Price.ToString("0.00")</div>
                        </div>
                        
                        <div class="package-details-list">
                            <div class="package-detail-item">
                                <div class="package-detail-left">
                                    <i class="bi bi-geo-alt"></i>
                                    <span>Location</span>
                                </div>
                                <div class="package-detail-right">
                                    @reservation.CanteenLocation.ToString().Replace("_", " ").Replace("BREDA", "Breda").Replace("TILBURG", "Tilburg").Replace("DENBOSCH", "Den Bosch").Replace("LA BUILDING", "LA Building").Replace("LD BUILDING", "LD Building").Replace("HA BUILDING", "HA Building")
                                </div>
                            </div>

                            <div class="package-detail-item">
                                <div class="package-detail-left">
                                    <i class="bi bi-calendar"></i>
                                    <span>Date</span>
                                </div>
                                <div class="package-detail-right">
                                    @reservation.PickupTime.ToString("dddd, MMMM dd yyyy")
                                </div>
                            </div>

                            <div class="package-detail-item">
                                <div class="package-detail-left">
                                    <i class="bi bi-clock"></i>
                                    <span>Pickup Time</span>
                                </div>
                                <div class="package-detail-right">
                                    @reservation.PickupTime.ToString("HH:mm") - @reservation.LatestPickupTime.ToString("HH:mm")
                                    @if (isPastDue)
                                    {
                                        <span class="warning-text">Expired</span>
                                    }
                                </div>
                            </div>

                            <div class="package-detail-item">
                                <div class="package-detail-left">
                                    <i class="bi bi-map"></i>
                                    <span>City</span>
                                </div>
                                <div class="package-detail-right">
                                    @reservation.City.ToString().Replace("BREDA", "Breda").Replace("TILBURG", "Tilburg").Replace("DENBOSCH", "Den Bosch")
                                </div>
                            </div>

                            <div class="package-detail-item">
                                <div class="package-detail-left">
                                    <i class="bi bi-tag"></i>
                                    <span>Meal Type</span>
                                </div>
                                <div class="package-detail-right">
                                    @switch (reservation.MealType)
                                    {
                                        case AvansMaaltijdreservering.Core.Domain.Enums.MealType.Bread:
                                            <text>Bread</text>
                                            break;
                                        case AvansMaaltijdreservering.Core.Domain.Enums.MealType.WarmEveningMeal:
                                            <text>Warm Evening Meal</text>
                                            break;
                                        case AvansMaaltijdreservering.Core.Domain.Enums.MealType.Drink:
                                            <text>Drink</text>
                                            break;
                                        case AvansMaaltijdreservering.Core.Domain.Enums.MealType.Snack:
                                            <text>Snack</text>
                                            break;
                                        case AvansMaaltijdreservering.Core.Domain.Enums.MealType.Lunch:
                                            <text>Lunch</text>
                                            break;
                                        case AvansMaaltijdreservering.Core.Domain.Enums.MealType.Breakfast:
                                            <text>Breakfast</text>
                                            break;
                                    }
                                </div>
                            </div>

                            @if (reservation.Products.Any())
                            {
                                <div class="package-detail-item package-detail-contents">
                                    <div class="package-detail-left">
                                        <i class="bi bi-box-seam"></i>
                                        <span>Contents</span>
                                    </div>
                                    <div class="package-detail-right">
                                        <div class="package-products">
                                            @foreach (var product in reservation.Products)
                                            {
                                                <div class="package-product package-product-with-image-tooltip">
                                                    <span class="package-product-name">@product.Name</span>
                                                    @if (product.ContainsAlcohol)
                                                    {
                                                        <i class="bi bi-exclamation-triangle-fill package-product-warning">
                                                            <div class="product-warning-tooltip">
                                                                Adults Only (18+) - This product contains alcohol
                                                            </div>
                                                        </i>
                                                    }
                                                    @if (!string.IsNullOrEmpty(product.PhotoUrl))
                                                    {
                                                        <div class="product-image-tooltip">
                                                            <img src="@product.PhotoUrl" alt="@product.Name" class="product-tooltip-image" />
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <p class="package-products-note">
                                            <small>Products shown are examples. Actual contents may vary - part of the surprise!</small>
                                        </p>
                                    </div>
                                </div>
                            }

                            @if (reservation.ContainsAlcohol())
                            {
                                <div class="package-detail-item package-detail-warning">
                                    <div class="package-detail-left">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <span>Age Restriction</span>
                                    </div>
                                    <div class="package-detail-right">
                                        <span class="warning-text">Adults Only (18+) - This package contains alcohol</span>
                                    </div>
                                </div>
                            }
                        </div>

                        @if (isUpcoming && !isPastDue)
                        {
                            <div class="package-details-buttons">
                                <form asp-action="CancelReservation" method="post">
                                    <input type="hidden" name="packageId" value="@reservation.Id" />
                                    <button type="button" class="btn-package-details" 
                                            onclick="showCancelModal(this.form)">
                                        <i class="bi bi-trash"></i> Cancel Reservation
                                    </button>
                                </form>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        
        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a asp-action="Dashboard" class="meal-filter-btn">
                    <i class="bi bi-search"></i> Browse More Packages
                </a>
            </div>
        </div>
    }

<!-- Success Modal -->
<div id="successModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h3 class="custom-modal-title">Reservation Successful!</h3>
        <p class="custom-modal-text" id="successModalText"></p>
        <div class="custom-modal-buttons">
            <button type="button" class="btn-modal-confirm" onclick="hideSuccessModal()">Great!</button>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h3 class="custom-modal-title">Cancel Reservation</h3>
        <p class="custom-modal-text">Are you sure you want to cancel this reservation? The package will become available to other students.</p>
        <div class="custom-modal-buttons">
            <button type="button" class="btn-modal-cancel" onclick="hideCancelModal()">Keep Reservation</button>
            <button type="button" class="btn-modal-confirm" onclick="confirmCancellation()">Cancel Reservation</button>
        </div>
    </div>
</div>

@section Scripts {
<script>
let currentCancelForm = null;

function showSuccessModal(message) {
    document.getElementById('successModalText').innerHTML = message;
    document.getElementById('successModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function hideSuccessModal() {
    document.getElementById('successModal').classList.remove('show');
    document.body.style.overflow = '';
}

function showCancelModal(form) {
    currentCancelForm = form;
    document.getElementById('cancelModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function hideCancelModal() {
    document.getElementById('cancelModal').classList.remove('show');
    document.body.style.overflow = '';
    currentCancelForm = null;
}

function confirmCancellation() {
    if (currentCancelForm) {
        currentCancelForm.submit();
    }
}

// Close modals when clicking outside
document.getElementById('successModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideSuccessModal();
    }
});

document.getElementById('cancelModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCancelModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideSuccessModal();
        hideCancelModal();
    }
});

// Check for success message on page load
@if (TempData["SuccessMessage"] != null)
{
    <text>
    document.addEventListener('DOMContentLoaded', function() {
        showSuccessModal('@Html.Raw(TempData["SuccessMessage"].ToString().Replace("'", "\\'"))');
    });
    </text>
}
</script>
}

</div>